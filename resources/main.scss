* { box-sizing: border-box; }
html {
    overflow: hidden;
}
body {
    font-family: "Helvetica Neue", arial, sans-serif;
}

a {
    text-decoration: none;
    /*color: #fff;*/
    color: inherit;
}

/* Theme colors: */
body {
    --main-background-color: #000;
    --background-noise: var(--dark-noise);

    --button-color: #888;
    --button-highlight-color: #eee;

    /* Colors for major UI boxes */
    --ui-bg-color: #222;
    --ui-fg-color: #fff;
    --ui-border-color: #000;
    --ui-shadow-color: #000; /* the shadow around some major UI elements */
    --ui-bg-section-color: #555; /* color for sections within UI, like the description box */

    --toggle-button-fg-disabled-color: #666;
    --toggle-button-fg-dim-color: #888;
    --toggle-button-fg-color: #fff;
    --toggle-button-bg-dim-color: #222;
    --toggle-button-bg-color: #444;

    /* Color for frames like popup menus */
    --frame-bg-color: #000;
    --frame-fg-color: #fff;
    --frame-border-color: #444;

    --dropdown-menu-hover-color: #444;

    /* Box links used for selection in the search UI: */
    --box-link-fg-color: var(--frame-fg-color);
    --box-link-bg-color: var(--frame-bg-color);
    --box-link-disabled-color: #888;
    --box-link-hover-color: #443;
    --box-link-selected-color: #008;

    /* Color for the minor text style, eg. the bookmark and like counts.
     * This is smaller text, with a text border applied to make it readable. */
    --minor-text-fg-color: #aaa;
    --minor-text-shadow-color: #000;

    --title-fg-color: #fff; /* title strip in image-ui */
    --title-bg-color: #444;

    --like-button-color: #888;
    --like-button-liked-color: #ccc;
    --like-button-hover-color: #fff;
}

body[data-theme="dark"]
{
    // Disable the lighter background noise when displaying an image.
    &[data-current-view="illust"] {
        --background-noise: "";
    }
}


body[data-theme="light"] {
    --main-background-color: #fff;
    --background-noise: var(--light-noise);

    --ui-bg-color: #eee;
    --ui-fg-color: #222;
    --ui-border-color: #ccc;
    --ui-shadow-color: #fff;
    --ui-bg-section-color: #ccc; /* color for subsections */

    --button-color: #666;
    --button-highlight-color: #222;

    --toggle-button-fg-dim-color: #222;
    --toggle-button-fg-color: #000;
    --toggle-button-bg-dim-color: #eee;
    --toggle-button-bg-color: #ccc;

    --frame-bg-color: #fff;
    --frame-fg-color: #222;

    --dropdown-menu-hover-color: #ccc;

    --box-link-hover-color: #ddc;
    --box-link-selected-color: #ffc;

    --minor-text-fg-color: #555; /* 555 */
    --minor-text-shadow-color: #fff; /* fff */

    --title-fg-color: #fff;
    --title-bg-color: #888;

    --like-button-liked-color: #222;
    --like-button-hover-color: #000;
}
ul {
    padding: 0;
    margin: 0;
}
.screen:focus {
    /* Views have tabindex: -1 set.  This causes Chrome to put a blue outline around them
     * when they're focused, which just puts a weird border around the whole window.  Remove
     * it. */
    outline: none;
}
.screen-illust-container {
    width: 100%;
    height: 100%;
}

.view-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    user-select: none;
    cursor: pointer;
}

.viewer-images {
    width: 100%;
    height: 100%;

    // If the image is cropped, set overflow: hidden on the image box to cut it
    // off.  Don't do this if it isn't needed, since it can trigger compositing
    // glitches in Chrome.
    > .image-box.cropping {
        overflow: hidden;
    }

    // Let the browser know about our dynamic zooming and panning.  This prevents Chrome from baking the
    // resize when it doesn't change for a while, which causes a big hitch the next time we zoom. */
    > .image-box img {
        will-change: transform;
    }
}

.viewer-ugoira, .viewer-video {
    width: 100%;
    height: 100%;
    > .video-container {
        width: 100%;
        height: 100%;
    }
}

[hidden] {
    display: none !important;
}

textarea:focus, input:focus, a:focus {
    outline: none;
}

/* Pixiv sometimes displays a random Recaptcha icon in the corner.  It's hard to prevent this since it
 * sometimes loads before we have a chance to stop it.  Try to hide it. */
.grecaptcha-badge {
    display: none !important;
}

.main-container {
    position: fixed;
    top: 0px;
    left: 0px;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: var(--main-background-color);
    background-image: var(--background-noise);
}
.progress-bar {
    position: absolute;
    pointer-events: none;
    background-color: #F00;
    bottom: 0px;
    left: 0px;
    width: 100%;
    height: 2px;
}
@keyframes flash-progress-bar { to { opacity: 0; } }
.progress-bar.hide {
    animation: flash-progress-bar 500ms linear 1 forwards;
}

.loading-progress-bar .progress-bar {
    z-index: 100;
}

// This holds the seek bar and video UI.
.video-ui
{
    position: absolute;
    bottom: 0px;
    left: 0px;
    width: 100%;
    user-select: none;

    transition: transform .25s, opacity .25s;
    opacity: 0;

    .seek-bar {
        width: 100%;
        box-sizing: content-box;
        height: 12px;
        cursor: pointer;
        position: relative;

        // If we're above the video UI, add some padding to make the seek bar easier to click.
        // If we're below, don't do this so we're flush against the bottom of the video UI.
        &[data-position="top"] { padding-top: 25px; }

        // Hide the seek bar by default.  Show it when the mouse is visible or .visible is set
        // (50% height).  Expand it while dragging (100% height).
        //
        // If the seek bar is at the bottom, disable vertical scaling since we're flush against
        // the bottom of the video UI.
        &[data-position="top"] > .seek-parts
        {
            transition: transform .25s;
            transform: scale(100%, 0%);
            transform-origin: bottom;
        }

        &[data-position="bottom"] {
            // The seek bar is very narrow when below the video UI.  This is only used when in
            // fullscreen, and it's assumed that you can just move the mouse to the bottom of the
            // screen.
            height: 4px;

            // If we're below the video UI, set the empty background to the same as the video UI.
            > .seek-parts > [data-seek-part="empty"] {
                background-color: rgba(0,0,0,0.5);
            }
        }

        // Scale to full size during drags.
        &.dragging > .seek-parts {
            transform: scale(100%, 100%) !important;
        }

        > .seek-parts {
            width: 100%;
            height: 100%;

            > [data-seek-part]
            {
                height: 100%;
                position: absolute;
                left: 0;
                top: 0;
            }

            > [data-seek-part="fill"] { background-color: #F00; }
            > [data-seek-part="loaded"] { background-color: #A00; }
            > [data-seek-part="empty"] {
                background-color: rgba(0,0,0,0.25);
                width: 100%;
            }
        }
    }

    // Stay visible if the mouse has moved recently, we're dragging, and while hovering
    // over the UI.
    .mouse-hidden-box.cursor-active &,
    &.dragging,
    &:hover
    {
        opacity: 1;

        .seek-bar[data-position="top"] > .seek-parts
        {
            transform: scale(100%, 50%);
        }
    }

    > .video-ui-strip
    {
        width: 100%;
        height: 100%;
        height: 3em;
        padding: 0 1em;
        display: flex;
        flex-direction: row;
        color: #ffffff;
        align-items: center;
        gap: 10px;
        background-color: rgba(0,0,0,0.5);

        // Tweak the vertical alignment for centering.
        padding-top: 4px;

        .button {
            cursor: pointer;
        }

        > .time {
            font-family: Roboto,Arial,Helvetica,sans-serif;
            font-size: 1.2em;
        }

        .volume-slider {
            width: 100px;
            height: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-right: -10px;

            > .volume-line {
                height: 4px;
                width: 100px;
                flex: 1;
            }
        }
    }
}

.title-font {
    font-weight: 700;
    font-size: 20px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell,
        Droid Sans, Helvetica Neue, Hiragino Kaku Gothic ProN, Meiryo, sans-serif;
}

.small-font {
    font-size: 0.8em;
}

.hover-message,
.search-results > .no-results {
    width: 100%;
    position: absolute;
    bottom: 0px;
    display: flex;
    justify-content: center;    

    & > .message {
        background-color: var(--frame-bg-color);
        color: var(--frame-fg-color);
        font-size: 1.4em;
        padding: 6px 15px;
        margin: 4px;
        max-width: 600px;
        text-align: center;
        border-radius: 5px;
        box-shadow: 0 0 10px 5px #aaa;
    }
}

.hover-message {
    transition: opacity .25s;
    opacity: 0;
    pointer-events: none;
    z-index: 100;

    &.show {
        opacity: 1;
    }
}

/* The version in the search container is always centered. */
.search-results > .no-results {
    bottom: 50%;
}

.screen-illust-container {
    .ui {
        position: absolute;
        top: 0px;
        left: 0px;
        min-width: 450px;
        max-height: 500px;
        width: 30%;
        height: auto;

        /* Disable events on the top-level container, so it doesn't block clicks on the
         * image when the UI isn't visible.  We'll reenable events on the hover-box and ui-box
         * below it where we actually want pointer events. */
        pointer-events: none;

        .disabled {
            display: none;
        }
    }
}

/*
 * This is the box that triggers the UI to be displayed.  We use this rather than
 * ui-box for this so we can give it a fixed size.  That way, the UI box won't suddenly
 * appear when changing to another image because a longer description caused the box
 * to become bigger.
 *
 * This is a little tricky.  Hovering over either hover-box or the UI makes it visible.
 * When the UI is hidden, it's set to pointer-events: none, so it can't be hovered,
 * but once you hover over hover-box and cause the UI to be visible, pointer events
 * are reenabled so hovering over anywhere in the UI keeps it visible.  The UI is
 * over hover-box in the Z order, so we don't need to disable pointer events on hover-box
 * to prevent it from blocking the UI.
 *
 * We also disable pointer-events on the UI until it's visible, so it doesn't receive
 * clicks until it's visible.
 */
.hover-box {
    width: 400px;
    height: 200px;
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: auto; /* reenable pointer events that are disabled on .ui */
}

.hover-sphere {
    width: 500px;
    height: 500px;

    /* Clamp the sphere to a percentage of the viewport width, so it gets smaller for
     * small windows. */
    max-width: 30vw;
    max-height: 30vw;
    position: absolute;
    top: 0;
    left: 0;

    circle {
        pointer-events: auto; /* reenable pointer events that are disabled on .ui */
    }

    &  > svg {
        width: 100%;
        height: 100%;
        transform: translate(-50%,-50%)
    }
}

.screen-manga-container .ui-container {
    width: 600px;
    max-width: 90%;
    pointer-events: auto;
}

.ui-box
{
    background-color: var(--ui-bg-color);
    color: var(--ui-fg-color);
    border: solid 2px var(--ui-border-color);
    padding: 1em;
    border-radius: 8px;
    position: relative;

    .author {
        vertical-align: top;
    }
    
    // Override the default visible-widget hiding behavior.
    &:not(.visible-widget)
    {
        display: inherit !important;
    }

    .screen-illust-container & {
        transition: transform .25s, opacity .25s;
        opacity: 0;
        transform: translate(-50px, 0);
        pointer-events: none;
        margin: .5em;
        
        /* Show the UI on hover when hide-ui isn't set. */
        body:not(.hide-ui) & {
            &.visible-widget
            {
                opacity: 1;
                transform: translate(0, 0);
                pointer-events: auto;
            }
        }

        /* Debugging: */
        body.force-ui & {
            opacity: 1;
            transform: translate(0, 0);
            pointer-events: inherit;
        }
    }

    /* Since the UI isn't a popup on the manga page, hide the description and
    * tag list to make it smaller.  These can be viewed while viewing a page. */
    .screen-manga-container &
    {
        & > .description,
        & > .tag-list
        {
            display: none;
        }
    }

    .button > svg {
        display: block;
    }

    .button.button-bookmark .count,
    .button.button-like .count
    {
        top: calc(100% - 11px);
        left: calc(-50px + 50%);
        width: 100px;
        pointer-events: none;
    }
}

.button-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    height: 32px;
    margin-top: 5px;
    margin-bottom: 4px;

    .button.enabled {
        cursor: pointer;
    }
}

/* The row with the search title, with buttons aligned to the right.  The buttons
 * are always aligned to the top if the title is long. */
.title-with-button-row {
    display: flex;
    flex-direction: row;
    align-items: start;
}

/* An icon in a button strip. */
.icon-button {
    display: block;
    width: 32px;
    height: auto;

    /* If this is an icon-button with an svg inside, set the svg to block. */
    svg {
        display: block;
    }
}

.disable-ui-button:hover > .icon-button {
    color: #0096FA;
}
.whats-new-button.updates > svg {
    color: #cc0;
}
body[data-theme="light"] .whats-new-button.updates > svg {
    color: #0aa; /* yellow doesn't work in a light theme */
}

.navigate-out-button {
    cursor: pointer;
}

.menu-slider input {
    vertical-align: middle;
    width: 100%;
    padding: 0;
    margin: 0;
    cursor: pointer;
}

.popup.avatar-popup:hover:after {
    left: auto;
    bottom: auto;
    top: 60px;
    right: -10px;
}

.follow-container {
    .avatar {
        transition: filter .25s;
        display: block;
        position: relative;
        box-shadow: 0 0 10px 4px #000;

        /* .avatar contains an image, and a canvas overlaid on top for hover effects. */
        & > canvas {
            border-radius: 5px;
            object-fit: cover;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        & > canvas.highlight {
            opacity: 0;
            transition: opacity .25s;
        }

        &:hover > canvas.highlight {
            opacity: 1;
        }
    }

    &:not(.big) .avatar {
        width: 50px;
        height: 50px;
    }

    &.big .avatar {
        width: 170px;
        height: 170px;
    }

    /* For the avatar in the popup menu, use the same size as the other popup menu buttons. */
    .avatar-widget-container & .avatar {
        width: 44px;
        height: 44px;
    }
}

/* Hide the avatar while we're waiting for user data to load, since the follow icons aren't
 * updated until then. */
.follow-container.loading {
    visibility: hidden;
    pointer-events: none;
}

/* The API doesn't tell us whether a follow is private or not, so we can't show
 * it.  The lock is only used to distinguish the "follow" and "follow privately"
 * buttons. */
.follow-icon {
    .lock {
        stroke: #888;
    }

    &:not(.private) .lock {
        display: none !important;
    }
}

.follow-container {
    .follow-icon {
        position: absolute;
        bottom: 0;
        text-align: center;
        height: auto;
        width: 50%; /* half the size of the container */
        max-width: 50px; /* limit the size for larger avatar displays */

        &.bottom-left {
            left: 0;
        }

        &.bottom-right {
            right: 0;
        }
    }

    .follow-icon:not(:hover) .outline1 {
        stroke: none !important;
    }

    /* Hide the following icon if we're not following. */
    &:not(.followed) .follow-icon.following-icon {
        display: none;
    }

    /* Hide the follow buttons if we're already following. */
    &.followed .follow-icon.follow-button {
        display: none;
    }

    /* Only show the follow buttons on hover (but always show the following icon). */
    &:not(:hover) .follow-icon.follow-button {
        display: none;
    }

    /* If use-dropdown is set, this avatar is using the dropdown UI and doesn't show the
     * follow/unfollow overlay buttons. */
    &[data-mode="dropdown"] .follow-icon.follow-button {
        display: none;
    }

    /* Don't show follow buttons or the follow popup for the user himself. */
    &.self .follow-icon,
    &.self .follow-popup
    {
        display: none;
    }

    /* In small avatar buttons, nudge the follow buttons down off of the
     * avatar, so they don't appear right under the cursor when you're trying
     * to click the avatar itself.  Only do this with the follow buttons that
     * appears on hover, not the following icon (unfollow button), and don't
     * do it with the big avatars. */
    &:not(.big) .follow-button {
        top: calc(100% - 5px);
    }

    .follow-icon > svg {
        display: block;
        width: 100%;
        height: auto;
        transition: opacity .25s;

        /* Move the icon down, so the bottom of the eye is along the bottom of the
         * container and the lock (if visible) overlaps. */
        margin-bottom: -20%;
    }

    &:not(:hover) .follow-icon > svg {
        opacity: 0.5;
    }

    /* Don't fade the icons in the context menu, since it's too small and it makes
     * it too hard to see at a glance. */
    .popup-context-menu & .follow-icon > svg {
        opacity: 1;
    }

    .follow-icon > svg .middle {
        transition: transform .1s ease-in-out;
        transform: translate(0px, -2px);
    }

    .follow-icon.unfollow-button > svg .middle {
        transform: translate(-2px, -5px);
    }

    .follow-icon.unfollow-button:hover > svg .middle {
        transform: translate(2px, 5px);
    }

    .follow-popup {
        margin-top: 10px;
        right: 0px;

        .folder {
            display: block;
            width: 100%;
        }

        .follow-container.followed & .not-following { display: none; }
        .follow-container:not(.followed) & .following { display: none; }

        input {
            padding: .25em;
        }
    }

    .hover-area {
        top: -12px;
    }

    .avatar-link {
        display: block;
    }
}

/* Hide the follow dropdown when following, since there's nothing in it. */
.follow-container.followed.popup-visible .popup-menu-box.hover-menu-box {
    visibility: hidden;
}

.title-block {
    display: inline-block;
    padding: 0 10px;
    color: var(--title-fg-color);
    background-color: var(--title-bg-color);
    margin-right: 1em;
    border-radius: 8px 0;

    &.popup:hover:after {
        top: 40px;
        bottom: auto;
    }
}

/* When .dot is set, show images with nearest neighbor filtering. */
body.dot img.filtering,
body.dot canvas.filtering {
    image-rendering: crisp-edges;
    image-rendering: pixelated;
}
.bulb-button:hover > .icon-button {
    color: #FF0 !important; /* override grey-icon hover color */
}

body[data-theme="light"] .bulb-button:hover > .icon-button {
    stroke: #000;
}

.bulb-button > .icon-button {
    margin-top: -3px;
}

.extra-profile-link-button {
    .default-icon svg {
        transform: translate(0, 2px);
    }
}

.post-info > * {
    display: inline-block;
    background-color: var(--box-link-bg-color);
    color: var(--box-link-fg-color);
    padding: 2px 10px;

    /* Use a smaller, heavier font to distinguish these from tags. */
    font-size: .8em;
    font-weight: bold;
}
.description {
    border: solid 1px var(--ui-border-color);
    padding: .35em;
    background-color: var(--ui-bg-section-color);
    max-height: 10em;
    overflow-y: auto;
}
body[data-theme="light"] .description {
    border: none;
}
/* Override obnoxious colors in descriptions.  Why would you allow this? */
.description * {
    color: var(--ui-fg-color);
}

.popup {
    position: relative;
}

.popup:hover:after {
    pointer-events: none;
    background: #111;
    border-radius: .5em;
    left: 0em;
    top: -2.0em;
    color: #fff;
    content: attr(data-popup);
    display: block;
    padding: .3em 1em;
    position: absolute;
    text-shadow: 0 1px 0 #000;
    white-space: nowrap;
    z-index: 98;
}
.popup-bottom:hover:after {
    top: auto;
    bottom: -2em;
}

body:not(.premium) .premium-only { display: none; }
body:not(.native) .native-only { display: none; }
body:not(.pixiv) .pixiv-only { display: none; }
body.hide-r18 .r18 { display: none; }
body.hide-r18g .r18g { display: none; }

.popup-menu-box {
    position: absolute;
    left: 0;
    top: 100%; // bottom of the positioning menu item
    min-width: 10em;
    background-color: var(--frame-bg-color);
    border: 1px solid var(--frame-border-color);
    padding: .25em .5em;
    z-index: 2;
}

.popup-menu-box.hover-menu-box {
    visibility: hidden;
}
.popup-visible .popup-menu-box.hover-menu-box {
    visibility: inherit;
}

/* This is an invisible block underneath the hover zone to keep the hover UI visible. */
.hover-area {
    position: absolute;
    top: -50%;
    left: -33%;
    width: 150%;
    height: 200%;
    z-index: -1;
}

.popup-menu-box .button
{
    padding: .25em;
    cursor: pointer;
    width: 100%;
}

.popup-menu-box .button:hover {
    background-color: var(--dropdown-menu-hover-color);
}

.top-ui-box
{
    /* This places the thumbnail UI at the top, so the thumbnails sit below it when
     * scrolled all the way up, and scroll underneath it. */
    position: sticky;
    top: 0;
    width: 100%;
    display: flex;
    flex-direction: row;
    align-items: center;
    padding-top: 1em;
    padding-bottom: .5em;
    z-index: 1;

    /* Prevent the empty space around the UI for centering from eating button presses. */
    pointer-events: none;

    /* If .ui-on-hover is set, switch to showing the top UI when it's hovered instead of sticky. */
    body.ui-on-hover &
    {
        position: fixed;
        top: auto;
        bottom: 100%;
        left: 0;
        transition: transform ease-out .2s;

        /* Normally pointer-events is disabled above, so the sides of the UI box don't cover clicks.
         * However, that also makes the hover not include the top padding above the UI, causing it
         * to flicker on and off when the mouse is in that area.  This is tricky to fix nicely, so just
         * stop disabling pointer-events when ui-on-hover is enabled. */
        pointer-events: auto;
    }

    /* This is used to temporarily disable the transition when the ui-on-hover setting is
     * changed in the options menu. */
    body.ui-on-hover &.disable-transition
    {
        transition: none;
    }
}

/* .force-open is set to lock the UI in place when a menu is open.  It has the same
 * effect as a hover. */
body.ui-on-hover .top-ui-box.hover,
body.ui-on-hover .top-ui-box.force-open
{
    transform: translateY(100%);
}

body.ui-on-hover .top-ui-box:not(.hover):not(.force-open)
{
    /* This is the amount the UI pokes on-screen when not hovered. */
    transform: translateY(40px);
}

/* When ui-on-hover is disabled we get spacing at the top of the thumbs automatically from
 * position: sticky, but ui-on-hover is position: fixed and we don't get that, so we have
 * to add padding manually. */
body.ui-on-hover .top-ui-box + .top-ui-box-padding
{
    height: 30px;
}

// Search result views.  This is used for both the search view and the manga page list.
// .search-results is the main scroller.
.search-screen {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    color: #fff;
    display: flex;
    flex-direction: row;

    .search-results {
        position: relative;
        width: 100%;
        height: 100%;

        overflow-x: hidden;

        // Always show the vertical scrollbar, so we don't relayout as images load.
        overflow-y: scroll;

        &:focus {
            outline: none;
        }
    }
}

.search-results {
    .thumbnail-ui-box-container {
        width: 50%;
        /* Make sure this doesn't get too narrow, or it'll overlap too much of the thumbnail area. */
        min-width: 800px;
    }
    .thumbnail-ui-box {
        width: 100%;
        background-color: var(--ui-bg-color);
        color: var(--ui-fg-color);
        box-shadow: 0 0 15px 10px var(--ui-shadow-color);
        border-radius: 4px;

        padding: 10px;
        pointer-events: auto;

        .disable-ui-button {
            margin-right: 2px;

            > svg {
                width: 22px;
            }
        }
        
        .displaying {
            padding-bottom: 4px;
        }
        .displaying .word {
            padding: 0px 5px;
        }

        .displaying .word:first-child {
            padding-left: 0px; /* remove left padding from the first item */
        }

        .displaying .word.or {
            font-size: 12px;
            padding: 0;
            color: #bbb;
        }

        .bookmarks-link > svg,
        .following-link > svg {
            width: 32px;
            height: 32px;
        }

        .contact-link > svg {
            width: 31px;
            height: 31px;
            margin: 0 3px;
        }

        .webpage-link > svg {
            margin: 0 2px;
            width: 26px;
            height: 26px;
        }

        .circlems-icon > svg {
            margin: 2px 0 0 0;
        }
    }

    /* .thumbnails is the actual thumbnail list. */
    .thumbnails {
        user-select: none;
        padding: 0;
        text-align: center;
    }

    .thumbnails {
        display: flex;
        flex-wrap: wrap;

        // Justify-content centers the thumbs within our max width, but margin: 0 auto
        // centers us within the window if our max width is smaller than the window.
        justify-content: center;
        margin: 0 auto; /* center */
    }

    .flash a {
        animation-name: flash-thumbnail;
        animation-duration: 300ms;
        animation-timing-function: ease-out;
        animation-iteration-count: 1;
    }    

    @keyframes flash-thumbnail {
        0% {
            filter: brightness(200%);
        }
    }

    // Marker above the last viewed image:
    .last-viewed-image-marker {
        position: absolute;
        left: 0;
        top: 0;
        pointer-events: none;

        // This is set by make_thumbnail_sizing_style based on the thumbnail size.
        // width: 100px;
        height: auto;
    }
    .thumbnail-box:not(.flash) .last-viewed-image-marker {
        display: none;
    }
}

.thumbnail-load-previous {
    width: 100%;

    & > .load-previous-buttons {
        margin-left: auto;
        margin-right: auto;
        display: flex;
        flex-direction: row;
        margin-top: 10px;
        margin-bottom: 4px;
        justify-content: center;
        height: 40px;
        max-width: 800px;

        & > .load-previous-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            margin: 0 10px;
            background-color: #880;
            border-radius: 4px;
            padding: 0 10px;
            color: var(--box-link-fg-color);
            background-color: var(--box-link-bg-color);

            &:hover {
                background-color: var(--box-link-hover-color);
            }
        }
    }
}

.thumbnail-box {
    /* Hide pending images (they haven't been set up yet). */
    &[data-pending] {
        visibility: hidden;
    }
    .thumbnail-inner {
        position: relative;
    }

    /*
     * thumbnail-box[data-nearby] is set on thumbs that are close to being onscreen.
     * If they don't have data-nearby, tell the browser they're not visible.  This
     * significantly improves performance when we have a lot of thumbs loaded, making
     * offscreen thumbs essentially free.
     *
     * Note that content-intrinsic-size is set programmatically.
     */
    &:not([data-nearby]) .thumbnail-inner {
        content-visibility: hidden;
    }

    a.thumbnail-link {
        display: block;
        width: 100%;
        height: 100%;

        border-radius: 4px;
        overflow: hidden;
        position: relative;
        text-decoration: none;
        color: #fff;
    }
}

.screen-search-container {
    .thumbnail-box {
        .similar-illusts-button {
            display: block;
            width: 32px;
            height: 32px;
            margin-top: -2px;
        }

        &:not(:hover) .similar-illusts-button {
            visibility: hidden;
        }

        .similar-illusts-button {
            color: #FF0 !important; /* override grey-icon hover color */
            opacity: 0.5;

            /* Use a very subtle stroke when not hovered, so it's not completely invisible
             * on light backgrounds. */
            stroke: rgba(0,0,0,0.5);
        }

        .similar-illusts-button:hover {
            opacity: 1;
            stroke: #000;
        }

        .bottom-row {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;

            // Slight padding between the icons and the text.  Note that this is applied even
            // if there's no icon, and it's applied to the empty flexes between the items, so
            // this is very small.
            gap: 4px;
            pointer-events: none;
            width: 100%;
            height: 32px;
            bottom: 3px;
            padding: 0 4px;

            // These are tricky.  We want the label to be centered, and if icons are shown in the
            // corners, the label stays centered as long as there's room.  It only shifts or shrinks
            // if we run out of space.  Give the boxes for icons an equal width and an extremely large
            // flex-shrink.  The boxes will try to be the same size if there's nothing inside them, so
            // they'll shrink by the same amount, and the huge flex-shrink will cause them to shrink
            // completely to make room for the label as needed.  If an icon is shown inside them the
            // box will have a minimum size and not shrink past that, but the shrinking will still
            // happen evenly until it reaches that size.
            .bottom-left-icon, .bottom-right-icon {
                height: 32px;
                width: 100px;
                flex-shrink: 100000;
                display: flex;
                align-items: center;
            }

            .bottom-right-icon {
                justify-content: end;
            }

            .thumbnail-label {
                display: flex;
                align-items: center;
                gap: .5em;
                flex-shrink: 1;
                white-space: nowrap;
                color: var(--frame-fg-color);
//                background-color: var(--frame-bg-color);
                background-color: rgba(0,0,0,.6);
                padding: 4px 8px;
                overflow: hidden;
                border-radius: 6px;

                .thumbnail-ellipsis-box {
                    text-overflow: ellipsis;
                    overflow: hidden;

                    & > .label {
                        /* Specify a line-height explicitly, so vertical centering is reasonably consistent for
                         * both EN and JP text. */
                        line-height: 19px;
                    }
                }
                
                .ugoira-icon {
                    color: #fff;
                    transition: opacity .5s;
                }
            }

            .heart {
                width: 32px;
                height: 32px;
                > svg {
                    transition: opacity .5s;
                }
            }

            .page-count-box {
                display: inline-block;
                padding: 4px 4px;
                background-color: rgba(0,0,0,.6);
                border-radius: 6px;
                transition: opacity .5s;
                white-space: nowrap;
                pointer-events: auto; // turn pointer events back on
                // margin-top: 2px; // nudge to fix alignment with titles
            
                .page-icon {
                    width: 16px;
                    height: 16px;
                    display: inline-block;
                    vertical-align: middle;
                }
            
                &:hover .regular {
                    display: none;
                }
                &:not(:hover) .hover {
                    display: none;
                }
            
                .page-count {
                    vertical-align: middle;
                    margin-left: -4px;
                }
            }                
        }
    }

    .thumbnail-inner:hover .heart > svg {
        opacity: 0.5;
    }
    .thumbnail-inner:hover .ugoira-icon {
        opacity: 0.5;
    }
}

.thumbnail-box
{
    .thumb {
        object-fit: cover;

        /* Show the top-center of the thunbnail.  This generally makes more sense
         * than cropping the center. */
        object-position: 50% 0%;    
        width: 100%;
        height: 100%;
    }

    // Hide the image while it's pending, so we don't show a broken image icon.
    &[data-pending] .thumb {
        display: none;
    }

    // Thumbnail zooming
    .thumb {
        transition: transform .5s;
        transform: scale(1, 1);
    }

    // If thumbnail zooming is enabled, zoom thumbs in while not hovered, or while
    // .pause-thumbnail-animation is set.
    body:not(.disable-thumbnail-zooming) & .thumbnail-inner:not(:hover),
    body:not(.disable-thumbnail-zooming).pause-thumbnail-animation &
    {
        .thumb {
            transform: scale(1.25, 1.25);
        }
    }

    // Thumbnail panning
    &.vertical-panning, &.horizontal-panning
    {
        .thumb {
            animation-duration: 4s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
        }
    }

    // Pause animations while the mouse isn't over them, or if pause-thumbnail-animation is set.
    .thumbnail-inner:not(:hover),
    body.pause-thumbnail-animation &
    {
        .thumb {
            animation-play-state: paused;
        }
    }

    body:not(.disable-thumbnail-panning) &.horizontal-panning .thumb {
        animation-name: pan-thumbnail-horizontally;
        object-position: left top;

        /* The full animation is 4 seconds, and we want to start 20% in, at the halfway
         * point of the first left-right pan, where the pan is exactly in the center where
         * we are before any animation.  This is different from vertical panning, since it
         * pans from the top, which is already where we start (top center). */
        animation-delay: -.8s;
    }

    body:not(.disable-thumbnail-panning) &.vertical-panning .thumb {
        animation-name: pan-thumbnail-vertically;
    }

    @keyframes pan-thumbnail-horizontally {
        /* This starts in the middle, pans left, pauses, pans right, pauses, returns to the middle, then pauses again. */
        0%   { object-position: left top; } /* left */
        40%  { object-position: right top; } /* pan right */
        50%  { object-position: right top; } /* pause */
        90%  { object-position: left top; } /* pan left */
        100%  { object-position: left top; } /* pause */
    }

    @keyframes pan-thumbnail-vertically {
        /* This starts at the top, pans down, pauses, pans back up, then pauses again. */
        0%   { object-position: 50% 0%; }
        40%  { object-position: 50% 100%; }
        50%  { object-position: 50% 100%; }
        90%  { object-position: 50% 0%; }
        100% { object-position: 50% 0%; }
    }

    &.muted {
        .muted-text {
            pointer-events: none;
            left: 0;
            top: 50%;
            width: 100%;
            height: 32px;
            position: absolute;
            color: #000;
            text-shadow: 0px 1px 1px #fff, 0px -1px 1px #fff, 1px 0px 1px #fff, -1px 0px 1px #fff;
            font-size: 22px;
        }

        /* Zoom muted images in a little, and zoom them out on hover, which is the opposite
         * of other images.  This also helps hide the black bleed around the edge caused by
         * the blur. */
        .thumb {
            filter: blur(10px);
            transform: scale(1.25, 1.25);
        }

        body:not(.disable-thumbnail-zooming) & .thumb:hover {
            transform: scale(1, 1);
        }
    }

    &:not(.muted) .muted-text {
        display: none;
    }
}

.screen-search-container {
    .following-tag {
        text-decoration: none;
    }
}

// A row of box-links inside a menu row.  This is used for menu items that have
// secondary buttons, like the public and private bookmark search buttons.  For
// these the main box-link doesn't stretch to fill the row, so it's easy to tell
// what button you're pressing, and the extra buttons are flush right.
.box-link-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.5em;

    // Note that the padding on box-links here matches the horizontal padding
    // on .vertical-list .box-link.
    > .box-link {
        padding-left: 0.5em;
        padding-right: 0.5em;
    }
}

// box-links in horizontal strips.  Add horizontal padding between these.
.box-button-row {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    align-items: center;

    > .box-link {
        margin: 0.25em .25em;
        padding: 0 .5em;

        // Place vertical padding on the contents rather than the box, so clicks are always
        // within one of the items and not on the small vertical padding around it.
        //
        // For box links that are just <a class=box-link>text</a>, the vertical padding is added
        // in the a.box-link rule.
        & > * {
            padding: .25em 0;
        }
    }
}

// box-links that are in a horizontal strip have vertical padding outside the box, to
// space them apart.  box-links that are in a vertical dropdown menu have their vertical
// padding inside the button, so there's no empty space between menu items.  The total
// padding stays the same.
.vertical-list
{
    // For box-links directly within the list (most of them), put the horizontal
    // padding on them.
    > .box-link { padding: 0 .5em; }

    > .box-link
    {
        display: flex;
        flex-direction: row;
        align-items: center;

        margin-top: 0;
        margin-bottom: 0;
    }
}

.box-link {
    display: inline-flex;
    cursor: pointer;
    text-decoration: none;
    margin: 0;
    padding: 0 .75em;
    align-content: center;
    align-items: center;
    height: 2em;

    color: var(--box-link-fg-color);
    background-color: var(--box-link-bg-color);
    user-select: none;
    white-space: nowrap;

    &.disabled {
        color: var(--box-link-disabled-color);
        cursor: auto;

        // Also prevent disabled links from showing an unfilled URL:
        pointer-events: none;
    }

    &:hover:not(.disabled) {
        background-color: var(--box-link-hover-color);
    }

    &.selected {
        background-color: var(--box-link-selected-color);
    }

    &.tag {
        /* Some tags are way too long, since translations don't put any sanity limit on length.
         * Cut these off so they don't break the layout. */
        max-width: 100%;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    // An icon on the left side.
    > .icon {
        display: inline-block;
        width: 1em;
        position: relative;
        top: 0.125em;
        margin-right: 0.25em;
        svg {
            width: auto;
            height: 1em;
        }
    }

    // This is set by set_active_popup_highlight.
    &.active {
        background-color: var(--box-link-selected-color);
    }
}

// box-link buttons that are A or SPAN don't have children, so put the padding on the box itself.
a.box-link, span.box-link
{
    padding-top: 0.5em;
    padding-bottom: 0.5em;
}

.search-box {
    white-space: nowrap;
    margin-bottom: 4px;
    position: relative; /* to position the search dropdown */
}

/* The block around the input box and submit button.  A history dropdown widget will
 * be placed in here. */
.tag-search-box {
    display: inline-block;
    position: relative;
}

.input-field-container {
    background-color: white;
    padding: 6px 10px;

    // Let the input box flex to fill our width, so the box stays the same size
    // and doesn't change if right-side-buttons are shown or hidden.
    display: inline-flex;
    gap: 0.25em;

    // Set a default width, so input has something to stretch to and stay a consistent
    // size if buttons are hidden.
    width: 300px;

    > input {
        background: none;
        border: none;
        font-size: 1.2em;
        vertical-align: middle;
        flex: 1;

        // Remove the default min-width.
        min-width: 0;
    }

    // Buttons to the right of the input box:
    > .right-side-button {
        display: inline-block;
        vertical-align: middle;
        cursor: pointer;
        user-select: none;
        color: black;

        & > svg
        {
            vertical-align: middle;
        }
    }
}

.search-submit-button {
    /* Work around HTML's stupid whitespace handling */
    font-size: 0;
    display: inline-block;
}

/* Search box in the menu: */
.navigation-search-box {
    .search-submit-button {
        vertical-align: middle;
        margin-left: -30px; /* overlap the search box */
    }
    input.search-tags {
        width: 100%;
        padding-right: 30px; /* extra space for the submit button */
    }
}

.thumbnail-ui-box .avatar-container {
    float: right;
    position: relative;
    margin-left: 25px;
}

.image-for-suggestions {
    float: right;
    margin-left: 25px;

    & > img {
        display: block;
        height: 150px;
        width: 150px;
        object-fit: cover;
        border-radius: 5px; /* matches the avatar display */
    }
}

.grey-icon {
    color: var(--button-color);
    cursor: pointer;

    // Highlight on hover.  If .parent-highlight is set, also highlight if the parent
    // is hovered.
    &:hover,
    :hover > &.parent-highlight
    {
        color: var(--button-highlight-color);
    }

    /* If a grey-icon is directly inside a visible popup menu, eg. the navigation icon: */
    .popup-visible > & {
        color: var(--button-highlight-color);
    }
}

.mute-display {
    .muted-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: blur(20px);
        opacity: .75;
    }

    .muted-text {
        position: absolute;
        width: 100%;
        top: 50%;
        left: 0;
        text-align: center;
        font-size: 30px;
        color: #000;
        text-shadow: 0px 1px 1px #fff, 0px -1px 1px #fff, 1px 0px 1px #fff, -1px 0px 1px #fff;
    }
}

/* Tag lists are usually inline.  Make the tag filter a vertical list. */
.member-tags-box .post-tag-list,
.search-tags-box .related-tag-list,
.bookmark-tags-box .bookmark-tag-list {
    max-height: 50vh;
    min-width: 20em;
    overflow-x: hidden;
    overflow-y: auto;
    white-space: nowrap;
}

// Adjusts the popup for the tag lists so they don't cover the tag.
.member-tags-box .post-tag-list .following-tag:hover:after,
.search-tags-box .related-tag-list .tag:hover:after,
.bookmark-tags-box .bookmark-tag-list .tag:hover:after {
    left: auto;
    right: 0px;
}

/* These affect both the search edit and search history boxes. */
.input-dropdown {
    width: 500px; /* overridden by script */
    max-width: 800px;
    margin: 1px;
    z-index: 1;
    user-select: none;

    /* Always show the vertical scrollbar.  Otherwise, the resize handle falls under the buttons
     * when it's not shown. */
    overflow-x: hidden;
    overflow-y: scroll;
    resize: horizontal;
    position: absolute;
    background-color: #fff;

    .search-history > & > .input-dropdown-list {
        display: flex;
        flex-direction: column;
        white-space: normal;
    }

    .input-dropdown-list > .entry {
        display: flex;
        flex-direction: row;
        color: #000;
        align-items: center;

        /* This 6px vertical padding should match the remove-history-entry padding. */
        padding: 6px 0;

        .search {
            color: #000;
            flex: 1;
            padding-left: 7px;
            height: 100%;
        }

        .search .word {
            display: inline-flex;
            align-items: center;
            height: 100%;
            padding: 0px 5px;

            &.or {
                font-size: 12px;
                padding: 0;
                color: #333;
            }
        }
    }

    /* Styles specific to the search history version of the dropdown: */
    .search-history > & > .input-dropdown-list {
        & > .entry .suggestion-icon {
            margin: 2px -2px 0 2px;    
        }
        & > .entry:not(.autocomplete) .suggestion-icon {
            display: none;
        }

        & > .entry.selected {
            background-color: #ffa;
        }

        & > .entry:hover {
            background-color: #ddd;
        }

        .remove-history-entry {
            height: 30px;
            width: 30px;

            /* Set an arbitrarily low negative margin.  This makes it so the button extends into the
             * into the surrounding row's padding instead of pushing the whole row out.  See
             * .input-dropdown-list > .entry padding. */
            margin: -6px 0;

            display: inline-flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
        }

        /* Hide the button to remove history entries from non-history entries. */
        & > .entry:not(.history) .remove-history-entry {
            display: none;
        }

        & > .entry:hover .remove-history-entry {
            visibility: visible;
        }
        .remove-history-entry:hover {
            color: #000;
            background-color: #c0c0c0;
        }
    }

    /* Styles specific to the edit search version of the dropdown. */
    .edit-search > & {
        padding: 4px 0;

        /* The edit search list is shown as a wrapped list, so enable wrapping and switch items from flex to inline-flex. */
        & > .input-dropdown-list {
            white-space: normal;
            max-width: 100%;

            & > .entry {
                display: inline-flex;
                & > A.search {
                    .tag.highlight { background-color: #eeee00; }
                    .tag:hover { background-color: #0099FF; }
                    .tag.highlight:hover { background-color: #00CCFF; }
                }
            }
        }
    }
}

.manga-thumbnail-container
{
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 240px;
    max-height: 30%;
    user-select: none;

    body.hide-ui &
    {
        display: none;
    }

    /* The .strip container is the overall strip.  This is a flexbox that puts the nav
     * arrows on the outside, and the thumb strip stretching in the middle.  The thumb
     * strip itself is also a flexbox, for the actual thumbs. */
    & > .strip
    {
        background-color: var(--ui-bg-color);
        height: 100%;
        display: flex;
        flex-direction: row;

        opacity: 0;
        transition: transform .15s, opacity .15s;
        transform: translate(0, 25px);

        & > .manga-thumbnails {
            flex: 1;

            display: flex;
            flex-direction: row;
            overflow: hidden;
            justify-content: left;
            scroll-behavior: smooth;
            height: 100%;
            padding: 5px 0;
        }
    }

    &.visible > .strip
    {
        opacity: 1;
        transform: translate(0, 0);
    }

    .manga-thumbnail-box
    {
        cursor: pointer;
        height: 100%;
        margin: 0 5px;

        /* The first entry has the cursor inside it.  Set these to relative, so the
         * cursor position is relative to it. */
        position: relative;

        img.manga-thumb
        {
            height: 100%;
            width: auto;
            border-radius: 3px;

            /* This will limit the width to 300px, cropping if needed.  This prevents
             * very wide aspect ratio images from breaking the layout.  Only a fixed
             * size will work here, percentage values won't work. */
            max-width: 400px;
            object-fit: cover;
        }
    }
}

.manga-thumbnail-arrow
{
    height: 100%;
    width: 30px;
    margin: 0 6px;

    & > svg
    {
        fill: #888;
    }
    &:hover > svg
    {
        fill: #ff0;
    }

    body[data-theme="light"] &
    {
        stroke: #aa0;
    }

    & > svg
    {
        display: block;
        height: 100%;
        width: 100%;
        padding: 4px;
    }
}

.thumb-list-cursor
{
    position: absolute;
    left: 0;
    bottom: -6px;
    width: 40px;
    height: 4px;
    background-color: var(--ui-fg-color);
    border-radius: 2px;
}

.widget:not(.visible-widget)
{
    display: none;
}

/* The right click context menu for the image view: */
.popup-context-menu {
    color: #fff;
    position: fixed;
    top: 100px;
    left: 350px;
    text-align: left;
    padding: 10px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    user-select: none;
    will-change: opacity, transform;
    transition:
        opacity ease 0.15s,
        transform ease 0.15s;

    // Override the default visible-widget hiding behavior.
    &:not(.visible-widget)
    {
        display: inherit;
        opacity: 0;
        pointer-events: none;
        transform: scale(.85);
    }

    &.visible-widget
    {
        opacity: 1;
    }

    & > * {
        transform-origin: unset;
    }

    /* Hide the normal tooltips.  The context menu shows them differently. */
    & .popup:hover:after {
        display: none;
    }

    & .tooltip-display {
        display: flex;
        align-items: stretch;
        padding: 10px 0 0 8px;
        pointer-events: none;
    }

    .tooltip-display .tooltip-display-text {
        background-color: var(--frame-bg-color);
        color: var(--frame-fg-color);
        padding: 2px 8px;
        border-radius: 4px;
    }

    .button-strip {
        display: flex;
        align-items: stretch;

        & > .button-block {
            display: inline-block;
            background-color: var(--frame-bg-color);
            padding: 12px;
        }

        /* Remove the double horizontal padding: */
        & > .button-block:not(:first-child) { padding-left: 0px; }

        /* Remove the double vertical padding.  Do this with a negative margin instead of zeroing
         * the padding, so the rounded black background stays the same size. */
        &:not(:last-child) > .button-block { margin-bottom: -12px; }

        /* Round the outer corners of each strip. */
        & > .button-block:first-child { border-radius: 5px 0 0 5px; }
        & > .button-block:last-child { border-radius: 0 5px 5px 0; }

        .button {
            border-radius: 4px;
            padding: 6px;
            height: 100%;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: var(--toggle-button-bg-dim-color);
            color: var(--toggle-button-fg-dim-color);

            /* Grey out the buttons if this strip isn't enabled. */
            &:not(.enabled)
            {
                cursor: inherit;
                color: var(--toggle-button-fg-disabled-color);
            }

            & > * {
                min-width: 32px;
            }
            & > svg {
                width: 32px;
                height: 32px;
            }

            &.enabled:hover {
                color: var(--toggle-button-fg-color);
            }

            &.enabled.selected {
                background-color: var(--toggle-button-bg-color);
                color: var(--toggle-button-fg-color);
            }

            /* We don't have a way to add classes to inlined SVGs yet, so for now just use nth-child.
               The first child is the + icon and the second child is -. */
            &.button-zoom:not(.selected) > :nth-child(1) { display: none; }
            &.button-zoom.selected > :nth-child(2) { display: none; }

            /* Popup menu bookmarking */
            .tag-dropdown-arrow {
                width: 0; 
                height: 0; 
                border-top: 10px solid #222;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
            }

            body[data-theme="light"] & .tag-dropdown-arrow {
                border-top-color: #ccc;
            }
        }

        /* This nudges the zoom strip to the left by the width of one button, to add the browser
         * back button to the left of other buttons. */
        & > .button-block.shift-left {
            margin-left: -56px;
        }
    }

    .context-menu-image-info {
        /* Bottom align within the row. */
        align-self: flex-end;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: var(--box-link-bg-color);
        padding-right: 8px;

        & > * {
            background-color: var(--box-link-bg-color);
            color: var(--box-link-fg-color);
            padding: 2px 0 0px 0px;
            font-size: .8em;
            font-weight: bold;
        }
    }

    .popup-bookmark-tag-dropdown {
        // Nudge the dropdown to the left by the width of a button-block
        // when it's inside the popup menu.
        right: -100%;
    }
}

.popup-more-options-container {
    .button-send-image {
        svg .arrow {
            transition: transform ease-in-out .15s;
        }

        &:not(.disabled):hover svg .arrow {
            transform: translate(2px, -2px);
        }
    }
}

.popup-bookmark-tag-dropdown,
.popup-more-options-dropdown {
    background-color: var(--frame-bg-color);
    color: var(--frame-fg-color);
    position: absolute;
    padding: 8px;
    top: calc(100%);
    border-radius: 0px 0px 4px 4px;

    /* Put this on top of other elements, like the image-ui tag list. */
    z-index: 1;

    /* In the context menu version, nudge the tag dropdown up slightly to cover
     * the rounded corners. */
    .popup-context-menu & {
        top: calc(100% - 4px);
    }

    & > .tag-list {
        display: flex;
        flex-direction: column;
        min-width: 200px;
        overflow-x: hidden;
        overflow-y: auto;
    }

    & > .tag-right-button-strip {
        position: absolute;
        top: 0;
        left: 100%;
        background-color: var(--frame-bg-color);
        color: var(--frame-fg-color);
        display: flex;
        flex-direction: column;
        align-items: stretch;

        .tag-button {
            cursor: pointer;
        }
    }

    /* Recent bookmark tags in the popup menu: */
    .popup-bookmark-tag-entry {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 4px 0px;
        display: flex;
        cursor: pointer;
        > .tag-name {
            flex: 1;
        }
                   &.active {
            background-color: #008;
        }
        body[data-theme="light"] &.active {
            background-color: #00c;
            color: #fff;
        }
                   &.active:hover {
            background-color: #00a;
        }
        body[data-theme="light"] &.active:hover {
            background-color: #00a;
        }
                   &:not(.active):hover {
            background-color: #222;
        }
        body[data-theme="light"] &:not(.active):hover {
            background-color: #ccc;
        }
    }
}

.button.button-bookmark .count,
.button.button-like .count
{
    color: var(--minor-text-fg-color);

    text-shadow:
        0px 1px 1px var(--minor-text-shadow-color),
        0px -1px 1px var(--minor-text-shadow-color),
        1px 0px 1px var(--minor-text-shadow-color),
        -1px 0px 1px var(--minor-text-shadow-color);
    font-size: .7em;
    font-weight: bold;
    position: absolute;
    top: calc(100% - 14px);
    left: 0;
    width: 100%;
    text-align: center;
}

/* Nudge the public heart icon up a bit to make room for the bookmark count. 
 * Only do this on the popup menu, not image-ui. */
.popup-context-menu .button.button-bookmark.public.has-like-count > svg
{
    margin-top: -10px;
}
.popup-context-menu .button.button-like > svg
{
    margin-top: -2px;
}

/* Bookmark buttons.  These appear in image_ui and the popup menu. */
.button.button-bookmark.will-delete.enabled:hover svg.heart-image .delete {
    display: inline;
}

/* Hide the "delete" stroke over the heart icon unless clicking the button will
 * remove the bookmark. */
svg.heart-image .delete {
    display: none;
}

/* These are !important to override the default white coloring in the context
 * menu. */
.button-bookmark {
    color: #400 !important;
    &.enabled {
        color: #800 !important;
        stroke: none;
    }

    &.bookmarked,
    &.enabled:hover {
        color: #f00 !important;
        stroke: none;
    }
}

/* Add a stroke around the heart on thumbnails for visibility.  Don't
 * change the black lock. */
.screen-search-container .thumbnails .button-bookmark svg > .heart {
    stroke: #000;
    stroke-width: .5px;
}

.button.button-like {
    /* This is a pain due to transition bugs in Firefox.  It doesn't like having
     * transition: transform on both an SVG and on individual paths inside the
     * SVG and clips the image incorrectly during the animation.  Work around this
     * by only placing transitions on the paths. */
    & > svg {
        color: var(--like-button-color);
    }

    &.liked > svg {
        color: var(--like-button-liked-color);
    }
    &.enabled:hover > svg {
        color: var(--like-button-hover-color);
    }
}

.button.button-browser-back {
    .arrow {
        transition: transform ease-in-out .15s;
        transform: translate(-2px, 0px);
    }
    &:hover .arrow {
        transform: translate(1px, 0px);
    }
}

.button.button-like               > svg > * {
    transition: transform ease-in-out .15s;
    transform: translate(0, 0px);
}
.button.button-like               > svg > .mouth {
    transform: scale(1, .75);
}

.button.button-like.liked         > svg > * {
    transform: translate(0, -3px);
}
.button.button-like.liked         > svg > .mouth {
    transform: scale(1, 1.1) translate(0, -3px);
}
.button.button-like.enabled:hover > svg > * {
    transform: translate(0, -2px);
}
.button.button-like.enabled:hover > svg > .mouth {
    transform: scale(1, .9) translate(0, -3px);
}
.button-bookmark.public svg.heart-image .lock {
    display: none;
}
.button-bookmark svg.heart-image .lock {
    stroke: #888;
}

.dialog {
    position: absolute;
    z-index: 1000;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.75);
    display: flex;
    align-items: center;
    justify-content: center;

    .content {
        font-size: 18px;
        max-width: 800px;
        background-color: var(--ui-bg-color);
        color: var(--ui-fg-color);
        border-radius: 5px;
        position: relative;

        & > .scroll {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 1em;
        }
    }

    .header {
        font-size: 40px;
        margin-bottom: 20px;
    }
}

.whats-new-box .content {
    width: 80%;
    height: 80%;

    .rev {
        display: inline-block;
        color: var(--box-link-fg-color);
        background-color: var(--box-link-bg-color);
        padding: 5px 10px;
    }
    .text {
        margin: 1em 0;
        padding: 0 20px; /* inset horizontally a bit */
    }
}

.close-button {
    position: absolute;
    top: 5px;
    right: -40px;
    color: var(--button-color);
    background-color: var(--ui-bg-color);
    padding: 4px;
    border-radius: 5px;
    cursor: pointer;
    &:hover {
        color: var(--button-highlight-color);
    }
    & > svg {
        display: block;
    }
}

.screen-illust-container {
    .page-change-indicator {
        position: absolute;
        height: 100%;
        display: flex;
        align-items: center;
        pointer-events: none;

        &[data-side="left"] {
            margin-left: 20px;
            left: 0;
        }

        &[data-side="right"] {
            margin-right: 20px;
            right: 0;
        }

        &[data-side="right"] svg {
            transform-origin: center center;
            transform: scale(-1, 1);
        }

        /* Hide the | portion of >| when showing last page rather than end of results. */
        &[data-icon="last-page"] svg .bar {
            display: none;
        }
        svg {
            opacity: 0;
        }
        &.flash svg {
            animation: flash-page-change-opacity 400ms ease-out 1 forwards;
        }

        &.flash svg .animated {
            animation: flash-page-change-part 300ms ease-out 1 forwards;
        }
    }

    @keyframes flash-page-change-opacity {
        0%   { opacity: 1; }
        40%  { opacity: 1; }
        80%  { opacity: 0; }
    }

    @keyframes flash-page-change-part {
        0%   { transform: translate( 0, 0px); }
        20%  { transform: translate(-4px, 0px); }
        100% { transform: translate( 0, 0px); }
    }
}

.link-tab-popup
{
    .explanation {
        max-width: 25em;
        width: 100%;
        text-align: center;
        margin: 0 auto;
    }

    .button {
        display: inline-block;
        cursor: pointer;
        background-color: #000;
        padding: .5em 1em;
        margin: .5em;
        border-radius: 5px;
    }

    .content {
        width: 400px;
        padding: 1em;
    }

    .buttons {
        display: flex;
    }

    .tutorial-monitor {
        width: 290px;
        height: 125px;

        // This SVG has padding on the bottom so the rotating monitor doesn't get clipped as
        // it turns.  Remove some of that for layout.
        margin-bottom: -20px;

        .rotating-monitor {
            transform-origin: 75px 30px;
            // transform: rotate(90deg);
            animation: rotate-monitor 4500ms linear infinite;

            @keyframes rotate-monitor {
                0% { transform: rotate(0deg); }
                10% { transform: rotate(90deg); }
                50% { transform: rotate(90deg); }
                60% { transform: rotate(0deg); }
            }
        }
    }
}

.send-image-popup
{
    .content {
        padding: 1em;
    }
}

.link-this-tab-popup, .send-image-here-popup
{
    > .box {
        border: 1px solid black;
        background-color: #000;
        color: #fff;
        padding: 1em;
    }

    .button {
        cursor: pointer;
        padding: 1em;
    }
}

.tag-entry-popup
{
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);

    > .strip {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        justify-content: center;
        > .box {
            background-color: #222;
            padding: 10px;
            color: #eee;
            position: relative;

            body[data-theme="light"] & {
                background-color: #ddd;
                color: #222;
            }
        }
    }

    .close-button {
        position: absolute;
        top: 0px;
        right: 0px;
        padding: 8px;
        cursor: pointer;
    }

    .tag-input-box {
        position: relative;
        display: flex;
        align-items: center;

        > .add-tag-input {
            flex: 1;
            padding: 4px;
        }
        > .submit-button {
            cursor: pointer;
            display: inline-block;
            width: 20px;
            text-align: center;
            margin-left: 6px;
            border: 1px solid white;
            body[data-theme="light"] & { border-color: #444; }
        }

        > .submit-button:hover {
            background-color: #444;
            body[data-theme="light"] & { background-color: #aaa; }
        }
    }
}

.years-ago {
    padding: .25em;
    margin: .25em;
    white-space: nowrap;
    /* These links are mostly the same as box-link, but since the
     * menu background is the same as the box-link background color,
     * shift it a little to make it clear these are buttons. */
    > a {
        padding: 4px 10px;
        background-color: #444;
        body[data-theme="light"] & {
            background-color: #ccc;
        }
    }
}

.tree 
{
    user-select: none;
    overflow-x: hidden;
    overflow-y: auto;
    flex: 1;

    .tree-item
    {
        position: relative;

        // If this isn't the root node, add padding to the left of our children.
        &:not(.root) > .items {
            margin-left: 1em;
        }

        &.selected > .self > .label
        {
            background-color: #003088;
        }

        > .self {
            display: flex;
            flex-direction: row;
            align-items: center;
            height: 2em;

            &:focus
            {
                // Hide the default focus outline.
                outline: none;

                > .label
                {
                    //background-color: #880;
                }
            }

            > .label
            {
                // This padding matches .tree-popup > .label.
                padding: 0.5em;
                white-space: nowrap;
            }
        
            &.root
            {
                display: none;
            }

            > .expander {
                display: flex;
                justify-content: center;
                align-items: center;
                
                font-size: 50%;
                width: 3em;
                height: 100%;

                & > .expander-button {
                    // Hide all buttons by default.
                    display: none;
                    width: 3em;
                    text-align: center;
                    vertical-align: middle;
                }

                // Modes are "none", "loading", "expandable" and "expanded".
                &[data-mode="loading"] > .loading
                {
                    display: block;
                }

                &[data-mode="none"] > .none
                {
                    display: block;
                }

                // Dim pending expanders.
                &[data-pending="true"] > .expand
                {
                    opacity: 0.5;
                }

                &[data-mode="expandable"] > .expand,
                &[data-mode="expanded"] > .expand
                {
                    display: block;
                }

                .expand
                {
                    transform: rotate(0deg);
                    transition: transform .25s;
                }

                &[data-mode="expanded"] > .expand
                {
                    transform: rotate(90deg);
                }
            }
        }
    }
}

.local-navigation-box {
    height: 100%;
    width: 25%;
    flex-shrink: 0;
    background-color: #111;
    border-right: solid 1px #444;
    padding-top: 0.5em;
    padding-left: 0.5em;
    opacity: 1;
    transition: opacity .35s, transform .35s;
    display: flex;
    flex-direction: column;

    // Not sure if this is worth bothering with.  Switching to position: fixed breaks the block
    // out so it doesn't affect layout, then shift and fade.
    &[hidden] {
        display: block !important;
        opacity: 0;
        pointer-events: none;
        position: fixed;
        transform: translate(-50%, 0);
    }
}

.tree-popup 
{
    background-color: #222;
    color: #fff;
    position: fixed;
    pointer-events: none;
    outline-style: dotted;
    outline-width: 1px;
    outline-color: #aaa;

    > .label
    {
        // This padding matches .tree .label.
        // padding: 0.5em;
        white-space: nowrap;
    }
}

.thumb-popup
{
    position: fixed;
    pointer-events: none;
    margin-left: 10px;
    width: 25%;
    height: 40%;
    max-height: 400px;
    max-width: 400px;
    > img
    {
        object-fit: contain;
        width: 100%;
        height: 100%;
    }
}

.settings-dialog
{

    .content {
        width: 80%;
        min-height: 30em;
        min-width: 800px;
        padding: 1em;

        & .box {
            display: flex;
            flex-direction: row;
    
            // The section selector on the left side of the settings dialog:
            .sections {
                white-space: nowrap;
                display: flex;
                flex-direction: column;

                > div {
                    padding: 0.5em;
                    cursor: pointer;

                    &:not(.selected) {
                        opacity: 0.65;
                    }

                    &:not(.active) {
                        background: none;
                    }

                    &:hover {
                        background-color: var(--box-link-hover-color);
                    }
                }
            }

            .items {
                flex: 1;
            }

            .settings-page {
                display: flex;
                flex-direction: column;

                .settings-row {
                    padding: 0.5em 1em;
                    gap: 1em;
                }
            
                .box-link {
                    // Disable some regular box-link styles:
                    height: auto;
                    background-color: inherit;
                
                    // Extra buttons (the linked tabs "edit" button):
                    > .buttons > .box-link {
                        padding: 0.35em .75em;
                    }
            
                    &.button {
                        background-color: var(--box-link-bg-color);
                    }
            
                    &.clickable:hover:not(.disabled) {
                        background-color: var(--box-link-hover-color);
                    }
            
                    // If this isn't a clickable row, such as a slider, disable effects on hover.
                    &:not(.clickable):hover {
                        cursor: inherit;
                        background: none;
                    }
            
                    .label-box {
                        margin-left: .25em;
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        gap: .25em;
                        .label {
                            padding-top: .25em; // adjust for descenders
                            margin: 0; // disable regular margin
                        }
            
                        .explanation {
                            font-size: 16px;
                            opacity: 0.75;
                        }
                    }
                }            
            }
        }
    }
    
    .close-button {
        position: absolute;
        top: 5px;
        right: 5px;
        color: var(--button-color);
        background-color: var(--ui-bg-color);
        padding: 4px;
        border-radius: 5px;
        cursor: pointer;
        &:hover {
            color: var(--button-highlight-color);
        }
        & > svg {
            display: block;
        }
    }
}

.close-local-search
{
    padding: 0.5em;
}

.image-editor {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1; // above the image
    pointer-events: none;

    .save-edits {
        &.dirty {
            color: #0f0;
        }

        & .spinner {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--box-link-bg-color);
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            & > span {
                display: block;
                font-size: 40px;
            }
        }
    }

    .image-editor-buttons {
        // If no editor is actually active, hide the top buttons with the mouse cursor.
        .mouse-hidden-box:not(.show-cursor) &.top {
            display: none;
        }

        &.top {
            top: 0;
        }
        &.bottom {
            bottom: 0;
        }
        position: absolute;
        display: flex;
        flex-direction: column;
        font-size: 150%;
        width: 100%;
        justify-content: center;
        align-items: center;
        .image-editor-button-row {
            pointer-events: auto;
        }
    }

    .spin {
        animation: spin 1000ms linear infinite forwards;
    }
    
    @keyframes spin {
        0%   { transform: rotate(0); }
        100% { transform: rotate(360deg); }
    }
}

.crop-editor-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    .crop-box {
        position: relative;
        cursor: move !important;        
        .crop-dim {
            position: absolute;
            background-color: #000;
            opacity: 0.5;
        }
    }

    .handle {
        &[data-crop="topleft"] { cursor: nw-resize !important; }
        &[data-crop="top"] { cursor: n-resize !important; }
        &[data-crop="topright"] { cursor: ne-resize !important; }
        &[data-crop="left"] { cursor: w-resize !important; }
        &[data-crop="right"] { cursor: e-resize !important; }
        &[data-crop="bottomleft"] { cursor: sw-resize !important; }
        &[data-crop="bottom"] { cursor: s-resize !important; }
        &[data-crop="bottomright"] { cursor: se-resize !important; }
    }

    .edge-handle {
        position: absolute;
    }
}

.inpaint-editor-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    &.creating-lines {
        cursor: crosshair !important;
    }

    .inpaint-segment {
        // inpaint-editor-overlay disables pointer-events.  Turn it back on here.
        pointer-events: auto;

        &.selected
        {
            .inpaint-line {
                //fill: #000;
                // stroke: #FFF;
            }
        }
        
        .inpaint-line {
            fill: none;
            stroke: #f00;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-opacity: 0.75;
            mix-blend-mode: difference;
        }

        &:hover {
            pointer-events: all;

            .inpaint-handle {
                stroke: #000;
            }
        }

        .inpaint-handle {
            opacity: 0;
        }

        &.selected .inpaint-handle,
        &:hover .inpaint-handle
        {
            opacity: 1;
        }

        .inpaint-handle {
            fill: none;
            opacity: 0.25;
            stroke: #000;
            pointer-events: all;
        }
    }
}
